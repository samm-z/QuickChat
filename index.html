<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QuickChat</title>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://unpkg.com/localbase@1.5.0/dist/localbase.dev.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Light theme */
      --bg-primary: #f0f4f8;
      --bg-secondary: #e2e8f0;
      --card-bg: #ffffff;
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --accent-primary: #3182ce;
      --accent-secondary: #4299e1;
      --border-color: #e2e8f0;
      --sent-bg: #3182ce;
      --sent-text: #ffffff;
      --received-bg: #e2e8f0;
      --received-text: #2d3748;
      --system-bg: #edf2f7;
      --system-text: #718096;
      --input-bg: #edf2f7;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --host-badge: #e53e3e;
      --footer-text: #718096;
      --success-color: #38a169;
    }

    [data-theme="dark"] {
      /* Dark theme */
      --bg-primary: #1a202c;
      --bg-secondary: #2d3748;
      --card-bg: #2d3748;
      --text-primary: #f7fafc;
      --text-secondary: #e2e8f0;
      --accent-primary: #4299e1;
      --accent-secondary: #63b3ed;
      --border-color: #4a5568;
      --sent-bg: #4299e1;
      --sent-text: #f7fafc;
      --received-bg: #4a5568;
      --received-text: #f7fafc;
      --system-bg: #2d3748;
      --system-text: #a0aec0;
      --input-bg: #4a5568;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --host-badge: #c53030;
      --footer-text: #a0aec0;
      --success-color: #48bb78;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-primary);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
      transition: background-color 0.3s ease;
    }

    .container {
      width: 95%;
      max-width: 800px;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 5px 15px var(--shadow-color);
      display: flex;
      flex-direction: column;
      height: 85vh;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeIn 0.6s forwards cubic-bezier(0.22, 1, 0.36, 1);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }

    /* Theme toggle switch */
    .theme-switch {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      z-index: 10;
    }

    .theme-switch-icon {
      font-size: 1.2rem;
      color: var(--accent-primary);
      cursor: pointer;
      transition: color 0.3s ease, transform 0.3s ease;
    }

    .theme-switch-icon:hover {
      color: var(--accent-secondary);
      transform: scale(1.1);
    }

    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--text-primary);
      transition: color 0.3s ease;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 30px;
      position: relative;
      padding-bottom: 10px;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 3px;
      background: var(--accent-primary);
      border-radius: 3px;
      transition: background-color 0.3s ease;
    }

    h2 {
      font-size: 1.4rem;
      color: var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .menu, .chat {
      display: none;
      flex-direction: column;
      flex: 1;
      gap: 15px;
      height: 100%;
    }

    .menu.active, .chat.active {
      display: flex;
      animation: fadeScale 0.5s forwards cubic-bezier(0.22, 1, 0.36, 1);
    }

    /* Fixed layout for chat interface */
    .chat.active {
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      flex-shrink: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-count {
      background-color: var(--accent-primary);
      color: white;
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .chat-footer {
      flex-shrink: 0;
      margin-top: 10px;
    }

    @keyframes fadeScale {
      0% {
        opacity: 0;
        transform: scale(0.98);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }

    input, button {
      width: 100%;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    }

    input {
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      border: 1px solid var(--border-color);
    }

    input:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.2);
    }

    button {
      background: var(--accent-primary);
      color: white;
      font-weight: 500;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: var(--accent-secondary);
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(66, 153, 225, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    /* 保存按钮动画 */
    .save-success {
      background-color: var(--success-color) !important;
    }

    .save-success i {
      animation: checkBounce 0.6s ease;
    }

    @keyframes checkBounce {
      0%, 100% {
        transform: scale(1);
      }
      25% {
        transform: scale(1.3);
      }
      50% {
        transform: scale(0.9);
      }
      75% {
        transform: scale(1.1);
      }
    }

    .chat-messages {
      flex: 1;
      margin: 10px 0;
      padding: 15px;
      overflow-y: auto;
      background: var(--bg-secondary);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 1px solid var(--border-color);
      scroll-behavior: smooth;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      min-height: 0;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 3px;
    }

    /* 消息输入区域样式 */
    .message-input-container {
      display: flex;
      gap: 10px;
      margin: 8px 0;
    }

    .message-input-container input {
      flex: 1;
      margin: 0;
    }

    .message-input-container button {
      width: 60px;
      margin: 0;
      height: 40px;
    }

    .message {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 15px;
      line-height: 1.5;
      word-break: break-word;
      opacity: 0;
      transform: translateY(10px);
      position: relative;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .message .sender {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 3px;
      opacity: 0.8;
    }

    .message .host-badge {
      display: inline-block;
      background-color: var(--host-badge);
      color: white;
      font-size: 0.6rem;
      padding: 2px 5px;
      border-radius: 10px;
      margin-left: 5px;
      vertical-align: middle;
    }

    /* 消息动画 */
    @keyframes messageFadeIn {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-animation {
      animation: messageFadeIn 0.4s forwards cubic-bezier(0.22, 1, 0.36, 1);
    }

    .sent {
      background: var(--sent-bg);
      color: var(--sent-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .received {
      background: var(--received-bg);
      color: var(--received-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .system {
      font-size: 13px;
      text-align: center;
      color: var(--system-text);
      margin: 8px 0;
      padding: 6px 12px;
      background: var(--system-bg);
      border-radius: 15px;
      width: fit-content;
      align-self: center;
      animation: systemFadeIn 0.5s forwards cubic-bezier(0.22, 1, 0.36, 1);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    @keyframes systemFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.95);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .exit-button {
      background: #e53e3e;
      margin-top: 10px;
    }

    .exit-button:hover {
      background: #c53030;
    }

    /* 密码选项样式 */
    .password-option {
      margin-top: 15px;
      margin-bottom: 10px;
    }

    .password-checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .password-checkbox-container input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .password-input {
      display: none;
    }

    .password-input.active {
      display: block;
      animation: fadeIn 0.3s forwards;
    }

    /* 昵称设置区域 */
    .nickname-container {
      margin-bottom: 15px;
    }

    .nickname-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .nickname-input input {
      flex: 1;
    }

    .nickname-input button {
      width: auto;
      padding: 10px 15px;
    }

    .footer {
      color: var(--footer-text);
      font-size: 0.8rem;
      margin-top: 1.25rem; /* 20px 相当于 1.25rem */
      text-align: center;
      transition: color 0.3s ease;
    }

    @media (max-width: 600px) {
      .container {
        padding: 20px;
        height: 90vh;
      }
      
      h1 {
        font-size: 1.6rem;
      }
      
      input, button {
        font-size: 14px;
        padding: 10px 14px;
      }
      
      .message {
        font-size: 14px;
        max-width: 85%;
      }

      .theme-switch {
        top: 15px;
        right: 15px;
      }
    }

    /* 漂浮输入框的样式 */
    .floating-div {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      width: 320px;
      padding: 25px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 10px 25px var(--shadow-color);
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1), 
                  background-color 0.3s ease, 
                  box-shadow 0.3s ease;
    }

    .floating-div.active {
      display: block;
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }

    .floating-div h3 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--text-primary);
      font-size: 1.3rem;
      position: relative;
      padding-bottom: 8px;
      transition: color 0.3s ease;
    }

    .floating-div h3::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 2px;
      background: var(--accent-primary);
      transition: background-color 0.3s ease;
    }

    .floating-div input {
      margin-bottom: 15px;
    }

    .floating-div .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s, background-color 0.3s ease, color 0.3s ease;
      padding: 0;
    }

    .floating-div .close-btn:hover {
      background: var(--accent-primary);
      color: white;
      transform: rotate(90deg);
    }

    /* 页面加载时容器渐变动画 */
    @keyframes fadeIn {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Theme toggle switch -->
  <div class="theme-switch">
    <i class="fas fa-sun theme-switch-icon" id="themeToggle" onclick="toggleTheme()"></i>
  </div>

  <div class="menu active" id="menu">
    <h1><i class="fas fa-comments"></i> QuickChat</h1>
    
    <!-- 昵称设置区域 -->
    <div class="nickname-container">
      <label for="nicknameInput">你的昵称</label>
      <div class="nickname-input">
        <input type="text" id="nicknameInput" placeholder="输入你的昵称">
        <button id="saveNicknameBtn" onclick="saveNickname()"><i class="fas fa-check"></i> 保存</button>
      </div>
    </div>
    
    <div class="menu-buttons">
      <button onclick="showCreateRoomOptions()"><i class="fas fa-plus-circle"></i> 创建房间</button>
      <button onclick="showJoinRoomInput()"><i class="fas fa-sign-in-alt"></i> 加入房间</button>
    </div>
    
    <!-- 创建房间的选项 (初始隐藏) -->
    <div id="createRoomOptions" style="display: none;">
      <div class="password-option">
        <div class="password-checkbox-container">
          <input type="checkbox" id="passwordCheckbox" onchange="togglePasswordInput()">
          <label for="passwordCheckbox">设置房间密码</label>
        </div>
        <div id="passwordInput" class="password-input">
          <input type="password" id="roomPassword" placeholder="输入房间密码">
        </div>
      </div>
      <div class="menu-buttons">
        <button onclick="createRoom()"><i class="fas fa-check-circle"></i> 确认创建</button>
        <button onclick="cancelCreateRoom()" style="background: #718096;"><i class="fas fa-times-circle"></i> 取消</button>
      </div>
    </div>

  </div>

  <div class="chat" id="chat">
    <!-- Fixed header -->
    <div class="chat-header">
      <h2><i class="fas fa-users"></i> <span id="roomInfo">房间号: </span></h2>
      <div class="user-count">
        <i class="fas fa-user"></i> <span id="userCount">1</span>
      </div>
    </div>
    
    <!-- Scrollable message area -->
    <div class="chat-messages" id="chatMessages"></div>
    
    <!-- Fixed footer with input and buttons -->
    <div class="chat-footer">
      <div class="message-input-container">
        <input type="text" id="messageInput" placeholder="输入消息...">
        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
      
      <button onclick="leaveRoom()" class="exit-button"><i class="fas fa-sign-out-alt"></i> 退出房间</button>
    </div>
  </div>
        <!-- 页脚 -->
        <div class="footer">
          ©️Copyright Sam Zhang 2025 v1.4
        </div>
</div>

<!-- 漂浮加入房间的输入框和按钮 -->
<div class="floating-div" id="floatingDiv">
  <button class="close-btn" onclick="hideJoinRoomInput()"><i class="fas fa-times"></i></button>
  <h3><i class="fas fa-door-open"></i> 加入聊天房间</h3>
  <input type="text" id="joinRoomInput" placeholder="输入房间号 (4位数)">
  <div id="joinPasswordInput" class="password-input">
    <input type="password" id="joinRoomPassword" placeholder="输入房间密码">
  </div>
  <button onclick="joinRoom()"><i class="fas fa-sign-in-alt"></i> 加入房间</button>
</div>


<script>
let peer;
let connections = [];
let roomId;
let isHost = false;
let roomPassword = null;
let username = localStorage.getItem('nickname') || "用户" + Math.floor(Math.random() * 1000);
let userCount = 1;

// 初始化昵称
function initNickname() {
  const nicknameInput = document.getElementById('nicknameInput');
  nicknameInput.value = username;
}

function saveNickname() {
  const saveBtn = document.getElementById('saveNicknameBtn');
  const newNickname = document.getElementById('nicknameInput').value.trim();
  
  if (newNickname) {
    // 添加保存成功动画
    saveBtn.classList.add('save-success');
    saveBtn.innerHTML = '<i class="fas fa-check"></i> 已保存';
    
    // 恢复按钮状态
    setTimeout(() => {
      saveBtn.classList.remove('save-success');
      saveBtn.innerHTML = '<i class="fas fa-check"></i> 保存';
    }, 2000);
    
    username = newNickname;
    localStorage.setItem('nickname', username);
    addSystemMessage(`昵称已更新为: ${username}`);
  } else {
    // 如果昵称为空，添加抖动效果
    saveBtn.classList.add('shake');
    setTimeout(() => {
      saveBtn.classList.remove('shake');
    }, 500);
  }
}

// 主题处理
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
  
  const themeToggle = document.getElementById('themeToggle');
  if (theme === 'dark') {
    themeToggle.classList.remove('fa-sun');
    themeToggle.classList.add('fa-moon');
  } else {
    themeToggle.classList.remove('fa-moon');
    themeToggle.classList.add('fa-sun');
  }
}

function toggleTheme() {
  const currentTheme = localStorage.getItem('theme') || 'light';
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  setTheme(newTheme);
}

function initTheme() {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    setTheme(savedTheme);
  } else {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
  }
}

initTheme();
initNickname();

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
  if (!localStorage.getItem('theme')) {
    setTheme(e.matches ? 'dark' : 'light');
  }
});

// 房间管理
function showCreateRoomOptions() {
  document.getElementById('createRoomOptions').style.display = 'block';
}

function cancelCreateRoom() {
  document.getElementById('createRoomOptions').style.display = 'none';
  document.getElementById('passwordCheckbox').checked = false;
  document.getElementById('passwordInput').classList.remove('active');
  document.getElementById('roomPassword').value = '';
}

function togglePasswordInput() {
  const isChecked = document.getElementById('passwordCheckbox').checked;
  const passwordInput = document.getElementById('passwordInput');
  if (isChecked) {
    passwordInput.classList.add('active');
  } else {
    passwordInput.classList.remove('active');
  }
}

if (localStorage.getItem('roomId')) {
  roomId = localStorage.getItem('roomId');
  isHost = localStorage.getItem('isHost') === 'true';
  roomPassword = localStorage.getItem('roomPassword');
  initPeer();
}

function createRoom() {
  roomId = Math.floor(1000 + Math.random() * 9000).toString();
  isHost = true;
  
  if (document.getElementById('passwordCheckbox').checked) {
    roomPassword = document.getElementById('roomPassword').value;
  } else {
    roomPassword = null;
  }
  
  localStorage.setItem('roomId', roomId);
  localStorage.setItem('isHost', 'true');
  if (roomPassword) {
    localStorage.setItem('roomPassword', roomPassword);
  } else {
    localStorage.removeItem('roomPassword');
  }
  
  initPeer();
  cancelCreateRoom();
}

function showJoinRoomInput() {
  const floatingDiv = document.getElementById('floatingDiv');
  floatingDiv.style.display = 'block';
  void floatingDiv.offsetWidth;
  floatingDiv.classList.add('active');
  document.getElementById('joinPasswordInput').classList.add('active');
  setTimeout(() => {
    document.getElementById('joinRoomInput').focus();
  }, 300);
}

function hideJoinRoomInput() {
  const floatingDiv = document.getElementById('floatingDiv');
  floatingDiv.classList.remove('active');
  setTimeout(() => {
    floatingDiv.style.display = 'none';
    document.getElementById('joinRoomInput').value = '';
    document.getElementById('joinRoomPassword').value = '';
  }, 400);
}

function joinRoom() {
  const input = document.getElementById('joinRoomInput').value.trim();
  
  if (input.length === 4) {
    roomId = input;
    isHost = false;
    roomPassword = document.getElementById('joinRoomPassword').value.trim();
    
    localStorage.setItem('roomId', roomId);
    localStorage.setItem('isHost', 'false');
    if (roomPassword) {
      localStorage.setItem('roomPassword', roomPassword);
    } else {
      localStorage.removeItem('roomPassword');
    }
    
    initPeer();
    hideJoinRoomInput();
  } else {
    const inputEl = document.getElementById('joinRoomInput');
    inputEl.style.borderColor = '#e53e3e';
    inputEl.style.boxShadow = '0 0 0 2px rgba(229, 62, 62, 0.2)';
    setTimeout(() => {
      inputEl.style.borderColor = '';
      inputEl.style.boxShadow = '';
    }, 1000);
    alert('请输入正确的四位房间号');
  }
}

// 连接管理
function initPeer() {
  document.getElementById('menu').classList.remove('active');
  document.getElementById('chat').classList.add('active');
  document.getElementById('roomInfo').textContent = `房间号: ${roomId}`;
  updateUserCount();

  if (isHost) {
    peer = new Peer(roomId);
    
    peer.on('open', () => {
      addSystemMessage('房间创建成功，等待其他用户加入...');
    });
    
    peer.on('connection', (conn) => {
      handleNewConnection(conn);
    });
  } else {
    peer = new Peer();
    
    peer.on('open', (id) => {
      const conn = peer.connect(roomId, {
        reliable: true,
        metadata: { username: username }
      });
      
      conn.on('open', () => {
        conn.send({
          type: 'auth',
          password: roomPassword,
          username: username
        });
        connections.push(conn);
        setupConnection(conn);
      });
      
      conn.on('error', (err) => {
        console.error('Connection error:', err);
        addSystemMessage('连接错误: ' + err.type);
      });
    });
  }

  peer.on('error', (err) => {
    console.error('Peer error:', err);
    if (err.type === 'peer-unavailable') {
      addSystemMessage('找不到指定的房间，请检查房间号是否正确');
    } else if (err.type === 'network' || err.type === 'disconnected') {
      addSystemMessage('网络错误，请检查您的网络连接');
    } else {
      addSystemMessage('连接错误: ' + err.type);
    }
  });
  
  document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendMessage();
  });
  
  document.getElementById('joinRoomInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') joinRoom();
  });
  
  document.getElementById('joinRoomPassword').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') joinRoom();
  });
}

function handleNewConnection(conn) {
  conn.on('open', () => {
    conn.on('data', (data) => {
      if (data.type === 'auth') {
        if (roomPassword && data.password !== roomPassword) {
          conn.send({
            type: 'auth-result',
            success: false,
            message: '密码错误'
          });
          setTimeout(() => conn.close(), 1000);
          return;
        }
        
        conn.send({
          type: 'auth-result',
          success: true,
          connectedUsers: connections.length + 1
        });
        
        conn.username = data.username;
        connections.push(conn);
        setupConnection(conn);
        
        if (isHost) {
          const joinMessage = `${data.username} 加入了房间`;
          addSystemMessage(joinMessage);
          broadcastSystemMessage(joinMessage);
          updateUserCount();
          broadcastUserCount();
        }
      }
    });
  });
}

function setupConnection(conn) {
  conn.on('data', (data) => {
    if (data.type === 'message') {
      addMessage(data.sender, data.content, 'received', data.isHost);
      
      // 只有房主需要转发消息，且不转发给自己
      if (isHost && data.sender !== username) {
        broadcastMessage(data.sender, data.content, conn);
      }
    } else if (data.type === 'system') {
      addSystemMessage(data.content);
    } else if (data.type === 'auth-result') {
      if (data.success) {
        addSystemMessage('连接成功，可以开始聊天了');
        userCount = data.connectedUsers;
        updateUserCount();
      } else {
        addSystemMessage(`连接失败: ${data.message}`);
        setTimeout(leaveRoom, 2000);
      }
    } else if (data.type === 'user-count') {
      userCount = data.count;
      updateUserCount();
    }
  });
  
  conn.on('close', () => {
    const index = connections.indexOf(conn);
    if (index > -1) connections.splice(index, 1);
    
    if (conn.username) {
      const leaveMessage = `${conn.username} 离开了房间`;
      addSystemMessage(leaveMessage);
      if (isHost) {
        broadcastSystemMessage(leaveMessage);
      }
    } else if (isHost) {
      const leaveMessage = '有用户离开了房间';
      addSystemMessage(leaveMessage);
      broadcastSystemMessage(leaveMessage);
    }
    
    if (isHost) {
      updateUserCount();
      broadcastUserCount();
    }
  });
}

function sendMessage() {
  const input = document.getElementById('messageInput');
  const content = input.value.trim();
  
  if (content) {
    addMessage(username, content, 'sent', isHost);
    
    if (isHost) {
      // 房主直接广播给所有客户端
      broadcastMessage(username, content);
    } else {
      // 客户端只发送给房主
      connections.forEach(conn => {
        if (conn.open) {
          conn.send({
            type: 'message',
            sender: username,
            content: content,
            isHost: false
          });
        }
      });
    }
    
    input.value = '';
    input.focus();
  }
}

function broadcastMessage(sender, content, exclude = null) {
  connections.forEach(conn => {
    if (conn.open && conn !== exclude) {
      conn.send({
        type: 'message',
        sender: sender,
        content: content,
        isHost: isHost
      });
    }
  });
}

function broadcastSystemMessage(content) {
  connections.forEach(conn => {
    if (conn.open) {
      conn.send({
        type: 'system',
        content: content
      });
    }
  });
}

function broadcastUserCount() {
  connections.forEach(conn => {
    if (conn.open) {
      conn.send({
        type: 'user-count',
        count: connections.length + 1
      });
    }
  });
}

function updateUserCount() {
  const count = isHost ? connections.length + 1 : userCount;
  document.getElementById('userCount').textContent = count;
}

function addMessage(sender, text, type, isHostMessage = false) {
  const msgDiv = document.createElement('div');
  msgDiv.classList.add('message', type);
  
  const senderSpan = document.createElement('span');
  senderSpan.classList.add('sender');
  senderSpan.textContent = sender;
  
  // 如果是房主消息，添加房主标志
  if (isHostMessage) {
    const hostBadge = document.createElement('span');
    hostBadge.classList.add('host-badge');
    hostBadge.textContent = '房主';
    senderSpan.appendChild(hostBadge);
  }
  
  msgDiv.appendChild(senderSpan);
  
  const contentSpan = document.createElement('span');
  contentSpan.textContent = text;
  msgDiv.appendChild(contentSpan);
  
  document.getElementById('chatMessages').appendChild(msgDiv);
  
  setTimeout(() => {
    msgDiv.classList.add('message-animation');
  }, 10);
  
  scrollToBottom();
}

function addSystemMessage(text) {
  const sysDiv = document.createElement('div');
  sysDiv.classList.add('system');
  sysDiv.textContent = text;
  document.getElementById('chatMessages').appendChild(sysDiv);
  scrollToBottom();
}

function scrollToBottom() {
  const div = document.getElementById('chatMessages');
  div.scrollTop = div.scrollHeight;
}

function leaveRoom() {
  if (peer) {
    peer.destroy();
    connections.forEach(conn => {
      if (conn.open) conn.close();
    });
    connections = [];
  }
  
  localStorage.removeItem('roomId');
  localStorage.removeItem('isHost');
  localStorage.removeItem('roomPassword');
  
  location.reload();
}
</script>

</body>
</html>
