<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>QuickChat</title>
  
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4ac.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4ac.svg">
  
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://unpkg.com/localbase@1.5.0/dist/localbase.dev.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Light theme */
      --bg-primary: #f0f4f8;
      --bg-secondary: #e2e8f0;
      --card-bg: #ffffff;
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --accent-primary: #3182ce;
      --accent-secondary: #4299e1;
      --border-color: #e2e8f0;
      --sent-bg: #3182ce;
      --sent-text: #ffffff;
      --received-bg: #e2e8f0;
      --received-text: #2d3748;
      --system-bg: #edf2f7;
      --system-text: #718096;
      --input-bg: #edf2f7;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --host-badge: #e53e3e;
      --footer-text: #718096;
      --success-color: #38a169;
      --modal-overlay: rgba(0, 0, 0, 0.5);
      --danger-color: #e53e3e;
      --warning-color: #dd6b20;
      --checkbox-bg: #edf2f7;
      --checkbox-checked-bg: #3182ce;
      --mention-bg: #fef3c7;
      --mention-text: #92400e;
      --reply-border: #cbd5e0;
    }

    [data-theme="dark"] {
      /* Dark theme */
      --bg-primary: #1a202c;
      --bg-secondary: #2d3748;
      --card-bg: #2d3748;
      --text-primary: #f7fafc;
      --text-secondary: #e2e8f0;
      --accent-primary: #4299e1;
      --accent-secondary: #63b3ed;
      --border-color: #4a5568;
      --sent-bg: #4299e1;
      --sent-text: #f7fafc;
      --received-bg: #4a5568;
      --received-text: #f7fafc;
      --system-bg: #2d3748;
      --system-text: #a0aec0;
      --input-bg: #4a5568;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --host-badge: #c53030;
      --footer-text: #a0aec0;
      --success-color: #48bb78;
      --modal-overlay: rgba(0, 0, 0, 0.7);
      --danger-color: #c53030;
      --warning-color: #c05621;
      --checkbox-bg: #4a5568;
      --checkbox-checked-bg: #4299e1;
      --mention-bg: #78350f;
      --mention-text: #fcd34d;
      --reply-border: #4a5568;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-text-size-adjust: 100%;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-primary);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
      transition: background-color 0.3s ease;
      touch-action: manipulation;
    }

    .container {
      width: 95%;
      max-width: 800px;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 5px 15px var(--shadow-color);
      display: flex;
      flex-direction: column;
      height: 85vh;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeIn 0.6s forwards cubic-bezier(0.22, 1, 0.36, 1);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }

    .theme-switch {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      z-index: 10;
    }

    .theme-switch-icon {
      font-size: 1.2rem;
      color: var(--accent-primary);
      cursor: pointer;
      transition: color 0.3s ease, transform 0.3s ease;
      padding: 8px;
      border-radius: 50%;
      background-color: var(--bg-secondary);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-switch-icon:hover {
      color: var(--accent-secondary);
      transform: scale(1.1);
    }

    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--text-primary);
      transition: color 0.3s ease;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 30px;
      position: relative;
      padding-bottom: 10px;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 3px;
      background: var(--accent-primary);
      border-radius: 3px;
      transition: background-color 0.3s ease;
    }

    h2 {
      font-size: 1.4rem;
      color: var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .menu, .chat {
      display: none;
      flex-direction: column;
      flex: 1;
      gap: 15px;
      height: 100%;
    }

    .menu.active, .chat.active {
      display: flex;
      animation: fadeScale 0.5s forwards cubic-bezier(0.22, 1, 0.36, 1);
    }

    .chat.active {
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      flex-shrink: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-count {
      background-color: var(--accent-primary);
      color: white;
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      position: relative;
      left: 0px;
      top: 30px;
    }

    .user-count:hover {
      background-color: var(--accent-secondary);
      transform: translateY(-2px);
    }

    .chat-footer {
      flex-shrink: 0;
      margin-top: 10px;
    }

    @keyframes fadeScale {
      0% {
        opacity: 0;
        transform: scale(0.98);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }

    input, button {
      width: 100%;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    }

    input {
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      border: 1px solid var(--border-color);
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    input:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.2);
    }

    button {
      background: var(--accent-primary);
      color: white;
      font-weight: 500;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: var(--accent-secondary);
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(66, 153, 225, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    .save-success {
      background-color: var(--success-color) !important;
    }

    .save-success i {
      animation: checkBounce 0.6s ease;
    }

    @keyframes checkBounce {
      0%, 100% {
        transform: scale(1);
      }
      25% {
        transform: scale(1.3);
      }
      50% {
        transform: scale(0.9);
      }
      75% {
        transform: scale(1.1);
      }
    }

    .chat-messages {
      flex: 1;
      margin: 10px 0;
      padding: 15px;
      overflow-y: auto;
      background: var(--bg-secondary);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 1px solid var(--border-color);
      scroll-behavior: smooth;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      min-height: 0;
      -webkit-overflow-scrolling: touch;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 3px;
    }

    .message-input-container {
      display: flex;
      gap: 10px;
      margin: 8px 0;
    }

    .message-input-container input {
      flex: 1;
      margin: 0;
    }

    .message-input-container button {
      width: 60px;
      margin: 0;
      height: 40px;
    }

    /* Ê∑ªÂä†ÂõûÂ§çÈ¢ÑËßàÊ†∑Âºè */
    .reply-preview {
      display: none;
      padding: 10px;
      margin-bottom: 8px;
      background-color: var(--bg-secondary);
      border-left: 3px solid var(--accent-primary);
      border-radius: 6px;
      position: relative;
    }

    .reply-preview.active {
      display: block;
    }

    .reply-preview-header {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .reply-preview-content {
      font-size: 0.9rem;
      color: var(--text-primary);
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 60px;
      overflow: hidden;
    }

    .reply-preview-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1rem;
      width: auto;
      padding: 0 5px;
      height: auto;
      margin: 0;
    }

    .reply-preview-close:hover {
      color: var(--danger-color);
    }

    /* Ê∑ªÂä†@ÊèêÁ§∫‰∏ãÊãâËèúÂçï */
    .mention-dropdown {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 0;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 100;
      min-width: 150px;
      box-shadow: 0 -5px 15px var(--shadow-color);
    }

    .mention-dropdown.active {
      display: block;
    }

    .mention-item {
      padding: 10px 15px;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }

    .mention-item:hover {
      background-color: var(--bg-secondary);
    }

    .mention-item.selected {
      background-color: var(--accent-primary);
      color: white;
    }

    /* Ê∑ªÂä†Ê∂àÊÅØÊìç‰ΩúÊåâÈíÆ */
    .message-actions {
      display: none;
      position: absolute;
      right: 0;
      top: 0;
      gap: 5px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 6px;
      padding: 5px;
    }

    .message:hover .message-actions {
      display: flex;
    }

    .action-btn {
      background: none;
      border: none;
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
      padding: 5px 8px;
      border-radius: 4px;
      width: auto;
      height: auto;
      margin: 0;
      transition: background-color 0.2s ease;
    }

    .action-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
      transform: none;
    }

    .message {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 15px;
      line-height: 1.5;
      word-break: break-word;
      opacity: 0;
      transform: translateY(10px);
      position: relative;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .message .sender {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 3px;
      opacity: 0.8;
    }

    .message .host-badge {
      display: inline-block;
      background-color: var(--host-badge);
      color: white;
      font-size: 0.6rem;
      padding: 2px 5px;
      border-radius: 10px;
      margin-left: 5px;
      vertical-align: middle;
    }

    /* Ê∑ªÂä†ÂõûÂ§çÂÜÖÂÆπÊòæÁ§∫ */
    .message-reply {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 5px;
      padding: 6px;
      background-color: rgba(0, 0, 0, 0.1);
      border-left: 2px solid currentColor;
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.9;
      transition: opacity 0.2s ease;
    }

    .message-reply:hover {
      opacity: 1;
    }

    .message-reply-sender {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .message-reply-content {
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 40px;
      overflow: hidden;
    }

    /* Ê∑ªÂä†@ÊèêÂèäÈ´ò‰∫Æ */
    .message-mention {
      background-color: var(--mention-bg);
      color: var(--mention-text);
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: 500;
    }

    @keyframes messageFadeIn {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-animation {
      animation: messageFadeIn 0.4s forwards cubic-bezier(0.22, 1, 0.36, 1);
    }

    .sent {
      background: var(--sent-bg);
      color: var(--sent-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .received {
      background: var(--received-bg);
      color: var(--received-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .system {
      font-size: 13px;
      text-align: center;
      color: var(--system-text);
      margin: 8px 0;
      padding: 6px 12px;
      background: var(--system-bg);
      border-radius: 15px;
      width: fit-content;
      align-self: center;
      animation: systemFadeIn 0.5s forwards cubic-bezier(0.22, 1, 0.36, 1);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    @keyframes systemFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.95);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .exit-button {
      background: #e53e3e;
      margin-top: 10px;
    }

    .exit-button:hover {
      background: #c53030;
    }

    .password-option {
      margin-top: 15px;
      margin-bottom: 10px;
    }

    .password-checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      position: relative;
    }

    .password-checkbox-container input[type="checkbox"] {
      opacity: 0;
      position: absolute;
      width: 0;
      height: 0;
    }

    .custom-checkbox {
      display: inline-block;
      width: 20px;
      height: 20px;
      background-color: var(--checkbox-bg);
      border: 2px solid var(--border-color);
      border-radius: 4px;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .password-checkbox-container input[type="checkbox"]:checked + .custom-checkbox {
      background-color: var(--checkbox-checked-bg);
      border-color: var(--checkbox-checked-bg);
    }

    .password-checkbox-container input[type="checkbox"]:checked + .custom-checkbox::after {
      content: '';
      position: absolute;
      left: 6px;
      top: 2px;
      width: 5px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      animation: checkmark 0.2s ease-in-out;
    }

    @keyframes checkmark {
      0% {
        opacity: 0;
        transform: rotate(45deg) scale(0.8);
      }
      100% {
        opacity: 1;
        transform: rotate(45deg) scale(1);
      }
    }

    .password-checkbox-container input[type="checkbox"]:focus + .custom-checkbox {
      box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.4);
    }

    .password-input {
      display: none;
    }

    .password-input.active {
      display: block;
      animation: fadeIn 0.3s forwards;
    }

    .nickname-container {
      margin-bottom: 15px;
    }

    .nickname-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .nickname-input input {
      flex: 1;
    }

    .nickname-input button {
      width: auto;
      padding: 10px 15px;
    }

    .footer {
      color: var(--footer-text);
      font-size: 0.8rem;
      margin-top: 1.25rem;
      text-align: center;
      transition: color 0.3s ease;
    }

    @media (max-width: 600px) {
      .container {
        padding: 20px;
        height: 90vh;
      }
      
      h1 {
        font-size: 1.6rem;
      }
      
      input, button {
        font-size: 16px;
        padding: 10px 14px;
      }
      
      .message {
        font-size: 14px;
        max-width: 85%;
      }

      .theme-switch {
        top: 15px;
        right: 15px;
      }

      .message-actions {
        display: flex;
      }

      .action-btn {
        font-size: 0.7rem;
        padding: 3px 6px;
      }
    }

    .floating-div {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      width: 320px;
      padding: 25px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 10px 25px var(--shadow-color);
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1), 
                  background-color 0.3s ease, 
                  box-shadow 0.3s ease;
    }

    .floating-div.active {
      display: block;
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }

    .floating-div h3 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--text-primary);
      font-size: 1.3rem;
      position: relative;
      padding-bottom: 8px;
      transition: color 0.3s ease;
    }

    .floating-div h3::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 2px;
      background: var(--accent-primary);
      transition: background-color 0.3s ease;
    }

    .floating-div input {
      margin-bottom: 15px;
    }

    .floating-div .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s, background-color 0.3s ease, color 0.3s ease;
      padding: 0;
    }

    .floating-div .close-btn:hover {
      background: var(--accent-primary);
      color: white;
      transform: rotate(90deg);
    }

    @keyframes fadeIn {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--modal-overlay);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
      display: block;
      opacity: 1;
    }

    .modal-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 25px var(--shadow-color);
      z-index: 1001;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .modal-overlay.active .modal-container {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
      font-size: 1.2rem;
      color: var(--text-primary);
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 5px;
      width: auto;
      height: auto;
      transition: color 0.2s ease;
    }

    .modal-close:hover {
      color: var(--accent-primary);
      transform: none;
      box-shadow: none;
    }

    .user-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .user-item {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 8px;
      background-color: var(--bg-secondary);
      transition: background-color 0.2s ease;
    }

    .user-item:last-child {
      margin-bottom: 0;
    }

    .user-item:hover {
      background-color: var(--border-color);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--accent-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-weight: 500;
      color: var(--text-primary);
      display: flex;
      align-items: center;
    }

    .user-status {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 3px;
    }

    .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }

    @keyframes shake {
      10%, 90% {
        transform: translate3d(-1px, 0, 0);
      }
      20%, 80% {
        transform: translate3d(2px, 0, 0);
      }
      30%, 50%, 70% {
        transform: translate3d(-3px, 0, 0);
      }
      40%, 60% {
        transform: translate3d(3px, 0, 0);
      }
    }

    .host-controls {
      margin-top: 15px;
      display: none;
    }

    .host-controls.active {
      display: block;
    }

    .host-controls-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .host-controls-buttons {
      display: flex;
      gap: 10px;
    }

    .host-controls-buttons button {
      flex: 1;
      padding: 8px;
    }

    .danger-button {
      background-color: var(--danger-color);
    }

    .danger-button:hover {
      background-color: var(--danger-color);
      opacity: 0.9;
    }

    .warning-button {
      background-color: var(--warning-color);
    }

    .warning-button:hover {
      background-color: var(--warning-color);
      opacity: 0.9;
    }

    .room-paused {
      pointer-events: none;
      opacity: 0.7;
    }

    .room-paused::after {
      content: 'ÊàøÈó¥Â∑≤ÊöÇÂÅú';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--warning-color);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 10;
    }

    .update-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      width: 90%;
      max-width: 450px;
      padding: 25px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 10px 30px var(--shadow-color);
      z-index: 1002;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .update-popup.active {
      display: block;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .update-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      gap: 15px;
    }

    .update-icon {
      width: 50px;
      height: 50px;
      background-color: var(--accent-primary);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .update-title {
      flex: 1;
    }

    .update-title h3 {
      font-size: 1.4rem;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .update-title p {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .update-content {
      margin-bottom: 20px;
      color: var(--text-primary);
      line-height: 1.6;
    }

    .update-content ul {
      margin-top: 10px;
      margin-left: 20px;
    }

    .update-content li {
      margin-bottom: 8px;
    }

    .update-content li:last-child {
      margin-bottom: 0;
    }

    .update-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .update-actions button {
      width: auto;
      padding: 10px 20px;
    }

    .update-actions .secondary-button {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
    }

    .update-actions .secondary-button:hover {
      background-color: var(--border-color);
    }

    .update-version {
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 15px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="theme-switch">
    <div class="theme-switch-icon" id="themeToggle" onclick="cycleTheme()">
      <i class="fas fa-sun" id="themeIcon"></i>
    </div>
  </div>

  <div class="menu active" id="menu">
    <h1><i class="fas fa-comments"></i> QuickChat</h1>
    
    <div class="nickname-container">
      <label for="nicknameInput">‰Ω†ÁöÑÊòµÁß∞</label>
      <div class="nickname-input">
        <input type="text" id="nicknameInput" placeholder="ËæìÂÖ•‰Ω†ÁöÑÊòµÁß∞">
        <button id="saveNicknameBtn" onclick="saveNickname()"><i class="fas fa-check"></i> ‰øùÂ≠ò</button>
      </div>
    </div>
    
    <div class="menu-buttons">
      <button onclick="showCreateRoomOptions()"><i class="fas fa-plus-circle"></i> ÂàõÂª∫ÊàøÈó¥</button>
      <button onclick="showJoinRoomInput()"><i class="fas fa-sign-in-alt"></i> Âä†ÂÖ•ÊàøÈó¥</button>
    </div>
  </div>

  <div class="chat" id="chat">
    <div class="chat-header">
      <h2><i class="fas fa-users"></i> <span id="roomInfo">ÊàøÈó¥Âè∑: </span></h2>
      <div class="user-count" onclick="showUserList()">
        <i class="fas fa-user"></i> <span id="userCount">1</span>
      </div>
    </div>
    
    <div class="chat-messages" id="chatMessages"></div>
    
    <div class="chat-footer">
      <!-- Ê∑ªÂä†ÂõûÂ§çÈ¢ÑËßà -->
      <div class="reply-preview" id="replyPreview">
        <div class="reply-preview-header">
          <span>ÂõûÂ§ç: <strong id="replyPreviewSender"></strong></span>
          <button class="reply-preview-close" onclick="cancelReply()">√ó</button>
        </div>
        <div class="reply-preview-content" id="replyPreviewContent"></div>
      </div>

      <!-- Ê∑ªÂä†@ÊèêÁ§∫‰∏ãÊãâËèúÂçï -->
      <div class="mention-dropdown" id="mentionDropdown"></div>

      <div class="message-input-container">
        <input type="text" id="messageInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ...ËæìÂÖ• @ ÊèêÂèäÁî®Êà∑">
        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
      
      <button onclick="leaveRoom()" class="exit-button"><i class="fas fa-sign-out-alt"></i> ÈÄÄÂá∫ÊàøÈó¥</button>
    </div>
  </div>

  <div class="footer">
    ¬©Ô∏èCopyright Sam Zhang 2025 v2.0 (Enhanced)
  </div>
</div>

<div class="floating-div" id="joinRoomDiv">
  <button class="close-btn" onclick="hideJoinRoomInput()"><i class="fas fa-times"></i></button>
  <h3><i class="fas fa-door-open"></i> Âä†ÂÖ•ËÅäÂ§©ÊàøÈó¥</h3>
  <input type="text" id="joinRoomInput" placeholder="ËæìÂÖ•ÊàøÈó¥Âè∑ (4‰ΩçÊï∞)">
  <div id="joinPasswordInput" class="password-input">
    <input type="password" id="joinRoomPassword" placeholder="ËæìÂÖ•ÊàøÈó¥ÂØÜÁ†Å">
  </div>
  <button onclick="joinRoom()"><i class="fas fa-sign-in-alt"></i> Âä†ÂÖ•ÊàøÈó¥</button>
</div>

<div class="floating-div" id="createRoomDiv">
  <button class="close-btn" onclick="hideCreateRoomOptions()"><i class="fas fa-times"></i></button>
  <h3><i class="fas fa-plus-circle"></i> ÂàõÂª∫ËÅäÂ§©ÊàøÈó¥</h3>
  <div class="password-checkbox-container">
    <input type="checkbox" id="passwordCheckbox" onchange="togglePasswordInput()">
    <label for="passwordCheckbox" class="custom-checkbox"></label>
    <label for="passwordCheckbox">ËÆæÁΩÆÊàøÈó¥ÂØÜÁ†Å</label>
  </div>
  <div id="passwordInput" class="password-input">
    <input type="password" id="roomPassword" placeholder="ËæìÂÖ•ÊàøÈó¥ÂØÜÁ†Å">
  </div>
  <button onclick="createRoom()"><i class="fas fa-check-circle"></i> Á°ÆËÆ§ÂàõÂª∫</button>
</div>

<div class="modal-overlay" id="userListModal">
  <div class="modal-container">
    <div class="modal-header">
      <div class="modal-title"><i class="fas fa-users"></i> ÊàøÈó¥ÊàêÂëò</div>
      <button class="modal-close" onclick="hideUserList()"><i class="fas fa-times"></i></button>
    </div>
    <ul class="user-list" id="userListContainer"></ul>
    
    <div class="host-controls" id="hostControls">
      <div class="host-controls-title">Êàø‰∏ªÊéßÂà∂</div>
      <div class="host-controls-buttons">
        <button class="warning-button" id="pauseRoomBtn" onclick="togglePauseRoom()">
          <i class="fas fa-pause"></i> ÊöÇÂÅúÊàøÈó¥
        </button>
        <button class="danger-button" onclick="deleteRoom()">
          <i class="fas fa-trash-alt"></i> Âà†Èô§ÊàøÈó¥
        </button>
      </div>
    </div>
  </div>
</div>

<div class="update-popup" id="updatePopup">
  <div class="update-header">
    <div class="update-icon">
      <i class="fas fa-bullhorn"></i>
    </div>
    <div class="update-title">
      <h3>Êñ∞ÁâàÊú¨Êõ¥Êñ∞</h3>
      <p>QuickChat Â∑≤Êõ¥Êñ∞Âà∞ v2.0</p>
    </div>
  </div>
  <div class="update-content">
    <p>ÊÑüË∞¢ÊÇ®‰ΩøÁî® QuickChatÔºÅÊàë‰ª¨ËøõË°å‰∫Ü‰ª•‰∏ãÊõ¥Êñ∞Ôºö</p>
    <ul>
      <li>‚ú® Ê∑ªÂä†Ê∂àÊÅØÂõûÂ§çÂäüËÉΩ - ÂèØÂõûÂ§ç‰ªªÊÑèÊ∂àÊÅØ</li>
      <li>‚ú® Ê∑ªÂä† @ÊèêÂèäÁî®Êà∑ÂäüËÉΩ - ËæìÂÖ• @ Âø´ÈÄüÊèêÂèä</li>
      <li>üéØ ÂÆåÊï¥‰øùÁïôÂéüÊúâÂäüËÉΩÂíåÊ†∑Âºè</li>
    </ul>
  </div>
  <div class="update-actions">
    <button onclick="hideUpdatePopup(true)">OK</button>
  </div>
  <div class="update-version">
    ÁâàÊú¨ 2.0 - 2025Âπ¥1Êúà16Êó•
  </div>
</div>

<script>
let peer;
let connections = [];
let roomId;
let isHost = false;
let roomPassword = null;
let username = localStorage.getItem('nickname') || "Áî®Êà∑" + Math.floor(Math.random() * 1000);
let userCount = 1;
let roomUsers = [];
let currentTheme = localStorage.getItem('theme') || 'system';
let isRoomPaused = false;
let currentAppVersion = '2.0';

let messageId = 0;
let messages = [];
let replyingTo = null;
let mentionUsers = [];
let mentionIndex = -1;

function initNickname() {
  const nicknameInput = document.getElementById('nicknameInput');
  nicknameInput.value = username;
}

function checkForUpdates() {
  const lastSeenVersion = localStorage.getItem('lastSeenVersion') || '1.9';
  
  if (lastSeenVersion !== currentAppVersion) {
    showUpdatePopup();
  }
}

function showUpdatePopup() {
  const updatePopup = document.getElementById('updatePopup');
  updatePopup.style.display = 'block';
  void updatePopup.offsetWidth;
  updatePopup.classList.add('active');
}

function hideUpdatePopup(dontShowAgain) {
  const updatePopup = document.getElementById('updatePopup');
  updatePopup.classList.remove('active');
  
  setTimeout(() => {
    updatePopup.style.display = 'none';
  }, 400);
  
  if (dontShowAgain) {
    localStorage.setItem('lastSeenVersion', currentAppVersion);
  }
}

function saveNickname() {
  const saveBtn = document.getElementById('saveNicknameBtn');
  const newNickname = document.getElementById('nicknameInput').value.trim();
  
  if (newNickname) {
    saveBtn.classList.add('save-success');
    saveBtn.innerHTML = '<i class="fas fa-check"></i> Â∑≤‰øùÂ≠ò';
    
    setTimeout(() => {
      saveBtn.classList.remove('save-success');
      saveBtn.innerHTML = '<i class="fas fa-check"></i> ‰øùÂ≠ò';
    }, 2000);
    
    username = newNickname;
    localStorage.setItem('nickname', username);
    addSystemMessage(`ÊòµÁß∞Â∑≤Êõ¥Êñ∞‰∏∫: ${username}`);
    
    if (connections.length > 0) {
      broadcastUserInfo();
    }
  } else {
    saveBtn.classList.add('shake');
    setTimeout(() => {
      saveBtn.classList.remove('shake');
    }, 500);
  }
}

function setTheme(theme) {
  currentTheme = theme;
  const themeIcon = document.getElementById('themeIcon');
  
  if (theme === 'system') {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    themeIcon.className = 'fas fa-desktop';
  } else if (theme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    themeIcon.className = 'fas fa-moon';
  } else {
    document.documentElement.setAttribute('data-theme', 'light');
    themeIcon.className = 'fas fa-sun';
  }
  
  localStorage.setItem('theme', theme);
}

function cycleTheme() {
  if (currentTheme === 'light') {
    setTheme('dark');
  } else if (currentTheme === 'dark') {
    setTheme('system');
  } else {
    setTheme('light');
  }
}

function initTheme() {
  setTheme(currentTheme);
  
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    if (currentTheme === 'system') {
      document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
    }
  });
}

initTheme();
initNickname();
document.addEventListener('DOMContentLoaded', checkForUpdates);

function showCreateRoomOptions() {
  const createRoomDiv = document.getElementById('createRoomDiv');
  createRoomDiv.style.display = 'block';
  void createRoomDiv.offsetWidth;
  createRoomDiv.classList.add('active');
}

function hideCreateRoomOptions() {
  const createRoomDiv = document.getElementById('createRoomDiv');
  createRoomDiv.classList.remove('active');
  setTimeout(() => {
    createRoomDiv.style.display = 'none';
    document.getElementById('passwordCheckbox').checked = false;
    document.getElementById('passwordInput').classList.remove('active');
    document.getElementById('roomPassword').value = '';
  }, 400);
}

function togglePasswordInput() {
  const isChecked = document.getElementById('passwordCheckbox').checked;
  const passwordInput = document.getElementById('passwordInput');
  if (isChecked) {
    passwordInput.classList.add('active');
  } else {
    passwordInput.classList.remove('active');
  }
}

if (localStorage.getItem('roomId')) {
  roomId = localStorage.getItem('roomId');
  isHost = localStorage.getItem('isHost') === 'true';
  roomPassword = localStorage.getItem('roomPassword');
  initPeer();
}

function createRoom() {
  roomId = Math.floor(1000 + Math.random() * 9000).toString();
  isHost = true;
  
  if (document.getElementById('passwordCheckbox').checked) {
    roomPassword = document.getElementById('roomPassword').value;
  } else {
    roomPassword = null;
  }
  
  localStorage.setItem('roomId', roomId);
  localStorage.setItem('isHost', 'true');
  if (roomPassword) {
    localStorage.setItem('roomPassword', roomPassword);
  } else {
    localStorage.removeItem('roomPassword');
  }
  
  initPeer();
  hideCreateRoomOptions();
}

function showJoinRoomInput() {
  const joinRoomDiv = document.getElementById('joinRoomDiv');
  joinRoomDiv.style.display = 'block';
  void joinRoomDiv.offsetWidth;
  joinRoomDiv.classList.add('active');
  document.getElementById('joinPasswordInput').classList.add('active');
  setTimeout(() => {
    document.getElementById('joinRoomInput').focus();
  }, 300);
}

function hideJoinRoomInput() {
  const joinRoomDiv = document.getElementById('joinRoomDiv');
  joinRoomDiv.classList.remove('active');
  setTimeout(() => {
    joinRoomDiv.style.display = 'none';
    document.getElementById('joinRoomInput').value = '';
    document.getElementById('joinRoomPassword').value = '';
  }, 400);
}

function joinRoom() {
  const input = document.getElementById('joinRoomInput').value.trim();
  
  if (input.length === 4) {
    roomId = input;
    isHost = false;
    roomPassword = document.getElementById('joinRoomPassword').value.trim();
    
    localStorage.setItem('roomId', roomId);
    localStorage.setItem('isHost', 'false');
    if (roomPassword) {
      localStorage.setItem('roomPassword', roomPassword);
    } else {
      localStorage.removeItem('roomPassword');
    }
    
    initPeer();
    hideJoinRoomInput();
  } else {
    const inputEl = document.getElementById('joinRoomInput');
    inputEl.style.borderColor = '#e53e3e';
    inputEl.style.boxShadow = '0 0 0 2px rgba(229, 62, 62, 0.2)';
    setTimeout(() => {
      inputEl.style.borderColor = '';
      inputEl.style.boxShadow = '';
    }, 1000);
    alert('ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÂõõ‰ΩçÊàøÈó¥Âè∑');
  }
}

function initPeer() {
  document.getElementById('menu').classList.remove('active');
  document.getElementById('chat').classList.add('active');
  document.getElementById('roomInfo').textContent = `ÊàøÈó¥Âè∑: ${roomId}`;
  updateUserCount();
  
  roomUsers = [{
    id: isHost ? roomId : null,
    username: username,
    isHost: isHost,
    joinTime: new Date().toISOString()
  }];

  if (isHost) {
    peer = new Peer(roomId);
    
    peer.on('open', (id) => {
      roomUsers[0].id = id;
      addSystemMessage('ÊàøÈó¥ÂàõÂª∫ÊàêÂäüÔºåÁ≠âÂæÖÂÖ∂‰ªñÁî®Êà∑Âä†ÂÖ•...');
    });
    
    peer.on('connection', (conn) => {
      handleNewConnection(conn);
    });
  } else {
    peer = new Peer();
    
    peer.on('open', (id) => {
      roomUsers[0].id = id;
      
      const conn = peer.connect(roomId, {
        reliable: true,
        metadata: { username: username }
      });
      
      conn.on('open', () => {
        conn.send({
          type: 'auth',
          password: roomPassword,
          username: username,
          userId: id
        });
        connections.push(conn);
        setupConnection(conn);
      });
      
      conn.on('error', (err) => {
        console.error('Connection error:', err);
        addSystemMessage('ËøûÊé•ÈîôËØØ: ' + err.type);
      });
    });
  }

  peer.on('error', (err) => {
    console.error('Peer error:', err);
    if (err.type === 'peer-unavailable') {
      addSystemMessage('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÊàøÈó¥ÔºåËØ∑Ê£ÄÊü•ÊàøÈó¥Âè∑ÊòØÂê¶Ê≠£Á°Æ');
    } else if (err.type === 'network' || err.type === 'disconnected') {
      addSystemMessage('ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•');
    } else {
      addSystemMessage('ËøûÊé•ÈîôËØØ: ' + err.type);
    }
  });
  
  document.getElementById('messageInput').addEventListener('keypress', handleMessageInputKeypress);
  document.getElementById('messageInput').addEventListener('input', handleMentionInput);
  
  document.getElementById('joinRoomInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') joinRoom();
  });
  
  document.getElementById('joinRoomPassword').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') joinRoom();
  });
}

function handleMentionInput(e) {
  const input = e.target;
  const text = input.value;
  const cursorPos = input.selectionStart;
  
  // Êü•ÊâæÊúÄÂêé‰∏Ä‰∏™ @ Á¨¶Âè∑
  const lastAtIndex = text.lastIndexOf('@', cursorPos - 1);
  
  if (lastAtIndex !== -1 && lastAtIndex === cursorPos - 1) {
    // @ ÂêéÈù¢Ê≤°ÊúâÂÜÖÂÆπÔºåÊòæÁ§∫ÊâÄÊúâÁî®Êà∑
    showMentionDropdown(text.substring(lastAtIndex));
  } else if (lastAtIndex !== -1) {
    // Ëé∑Âèñ @ ÂêéÁöÑÊñáÊú¨
    const searchText = text.substring(lastAtIndex + 1, cursorPos);
    
    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊúâÊïàÁöÑÊêúÁ¥¢ÔºàÂè™ÊúâÂ≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÔºâ
    if (/^[a-zA-Z0-9_\u4e00-\u9fff]*$/.test(searchText)) {
      showMentionDropdown('@' + searchText);
    } else {
      hideMentionDropdown();
    }
  } else {
    hideMentionDropdown();
  }
}

function showMentionDropdown(searchText) {
  const dropdown = document.getElementById('mentionDropdown');
  const search = searchText.substring(1).toLowerCase();
  
  const matchedUsers = roomUsers.filter(user => 
    user.username.toLowerCase().includes(search) && user.username !== username
  );
  
  if (matchedUsers.length === 0) {
    hideMentionDropdown();
    return;
  }
  
  dropdown.innerHTML = '';
  mentionIndex = -1;
  mentionUsers = matchedUsers;
  
  matchedUsers.forEach((user, index) => {
    const item = document.createElement('div');
    item.className = 'mention-item';
    item.innerHTML = `<i class="fas fa-user-circle"></i> ${user.username}`;
    item.onclick = () => selectMention(user.username);
    dropdown.appendChild(item);
  });
  
  dropdown.classList.add('active');
}

function hideMentionDropdown() {
  const dropdown = document.getElementById('mentionDropdown');
  dropdown.classList.remove('active');
  mentionUsers = [];
  mentionIndex = -1;
}

function selectMention(username) {
  const input = document.getElementById('messageInput');
  const text = input.value;
  const cursorPos = input.selectionStart;
  
  const lastAtIndex = text.lastIndexOf('@', cursorPos - 1);
  
  if (lastAtIndex !== -1) {
    const beforeAt = text.substring(0, lastAtIndex);
    const afterCursor = text.substring(cursorPos);
    
    const newText = beforeAt + '@' + username + ' ' + afterCursor;
    input.value = newText;
    input.selectionStart = input.selectionEnd = beforeAt.length + username.length + 2;
    
    hideMentionDropdown();
    input.focus();
  }
}

function handleMessageInputKeypress(e) {
  if (e.key === 'Enter') {
    if (document.getElementById('mentionDropdown').classList.contains('active')) {
      if (mentionUsers.length > 0) {
        mentionIndex = (mentionIndex + 1) % mentionUsers.length;
        updateMentionSelection();
      }
    } else {
      sendMessage();
    }
  }
}

function updateMentionSelection() {
  const items = document.querySelectorAll('.mention-item');
  items.forEach((item, index) => {
    if (index === mentionIndex) {
      item.classList.add('selected');
    } else {
      item.classList.remove('selected');
    }
  });
}

function cancelReply() {
  replyingTo = null;
  const preview = document.getElementById('replyPreview');
  preview.classList.remove('active');
}

function replyToMessage(msgId) {
  const msg = messages.find(m => m.id === msgId);
  if (!msg) return;
  
  replyingTo = msg;
  const preview = document.getElementById('replyPreview');
  document.getElementById('replyPreviewSender').textContent = msg.sender;
  document.getElementById('replyPreviewContent').textContent = msg.content;
  preview.classList.add('active');
  
  document.getElementById('messageInput').focus();
}

function handleNewConnection(conn) {
  conn.on('open', () => {
    conn.on('data', (data) => {
      if (data.type === 'auth') {
        if (roomPassword && data.password !== roomPassword) {
          conn.send({
            type: 'auth-result',
            success: false,
            message: 'ÂØÜÁ†ÅÈîôËØØ'
          });
          setTimeout(() => conn.close(), 1000);
          return;
        }
        
        const newUser = {
          id: data.userId,
          username: data.username,
          isHost: false,
          joinTime: new Date().toISOString(),
          conn: conn
        };
        
        roomUsers.push(newUser);
        
        conn.send({
          type: 'auth-result',
          success: true,
          connectedUsers: connections.length + 1,
          userList: roomUsers.map(user => ({
            id: user.id,
            username: user.username,
            isHost: user.isHost,
            joinTime: user.joinTime
          })),
          isRoomPaused: isRoomPaused
        });
        
        conn.username = data.username;
        conn.userId = data.userId;
        connections.push(conn);
        setupConnection(conn);
        
        if (isHost) {
          const joinMessage = `${data.username} Âä†ÂÖ•‰∫ÜÊàøÈó¥`;
          addSystemMessage(joinMessage);
          broadcastSystemMessage(joinMessage);
          updateUserCount();
          broadcastUserCount();
          broadcastUserList();
        }
      }
    });
  });
}

function setupConnection(conn) {
  conn.on('data', (data) => {
    if (data.type === 'message') {
      if (isRoomPaused && !data.isHost && isHost) {
        return;
      }
      
      addMessage(data.sender, data.content, 'received', data.isHost, data.replyTo, data.mentions);
      
      if (isHost && data.sender !== username) {
        broadcastMessage(data.sender, data.content, conn, data.replyTo, data.mentions);
      }
    } else if (data.type === 'system') {
      addSystemMessage(data.content);
    } else if (data.type === 'auth-result') {
      if (data.success) {
        addSystemMessage('ËøûÊé•ÊàêÂäüÔºåÂèØ‰ª•ÂºÄÂßãËÅäÂ§©‰∫Ü');
        userCount = data.connectedUsers;
        updateUserCount();
        
        if (data.userList) {
          roomUsers = data.userList;
          if (!roomUsers.find(user => user.id === peer.id)) {
            roomUsers.push({
              id: peer.id,
              username: username,
              isHost: false,
              joinTime: new Date().toISOString()
            });
          }
        }
        
        if (data.isRoomPaused) {
          setRoomPaused(true);
        }
      } else {
        addSystemMessage(`ËøûÊé•Â§±Ë¥•: ${data.message}`);
        setTimeout(leaveRoom, 2000);
      }
    } else if (data.type === 'user-count') {
      userCount = data.count;
      updateUserCount();
    } else if (data.type === 'user-list') {
      roomUsers = data.userList;
    } else if (data.type === 'user-info-update') {
      const userIndex = roomUsers.findIndex(user => user.id === data.userId);
      if (userIndex !== -1) {
        roomUsers[userIndex].username = data.username;
      }
    } else if (data.type === 'room-control') {
      if (data.action === 'pause') {
        setRoomPaused(data.paused);
        addSystemMessage(data.paused ? 'Êàø‰∏ªÂ∑≤ÊöÇÂÅúÊàøÈó¥' : 'Êàø‰∏ªÂ∑≤ÊÅ¢Â§çÊàøÈó¥');
      } else if (data.action === 'delete') {
        addSystemMessage('Êàø‰∏ªÂ∑≤Âà†Èô§ÊàøÈó¥');
        setTimeout(leaveRoom, 2000);
      }
    }
  });
  
  conn.on('close', () => {
    const index = connections.indexOf(conn);
    if (index > -1) connections.splice(index, 1);
    
    const userIndex = roomUsers.findIndex(user => user.id === conn.userId);
    if (userIndex > -1) {
      const leftUser = roomUsers[userIndex];
      roomUsers.splice(userIndex, 1);
      
      if (leftUser.username) {
        const leaveMessage = `${leftUser.username} Á¶ªÂºÄ‰∫ÜÊàøÈó¥`;
        addSystemMessage(leaveMessage);
        if (isHost) {
          broadcastSystemMessage(leaveMessage);
        }
      } else if (isHost) {
        const leaveMessage = 'ÊúâÁî®Êà∑Á¶ªÂºÄ‰∫ÜÊàøÈó¥';
        addSystemMessage(leaveMessage);
        broadcastSystemMessage(leaveMessage);
      }
    }
    
    if (isHost) {
      updateUserCount();
      broadcastUserCount();
      broadcastUserList();
    }
  });
}

function sendMessage() {
  if (isRoomPaused && !isHost) {
    addSystemMessage('ÊàøÈó¥Â∑≤Ë¢´ÊöÇÂÅúÔºåÊöÇÊó∂Êó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ');
    return;
  }
  
  const input = document.getElementById('messageInput');
  const content = input.value.trim();
  
  if (content) {
    messageId++;
    
    const mentions = [];
    const mentionRegex = /@([^\s@]+)/g;
    let match;
    while ((match = mentionRegex.exec(content)) !== null) {
      mentions.push(match[1]);
    }
    
    addMessage(username, content, 'sent', isHost, replyingTo, mentions);
    
    if (isHost) {
      broadcastMessage(username, content, null, replyingTo, mentions);
    } else {
      connections.forEach(conn => {
        if (conn.open) {
          conn.send({
            type: 'message',
            sender: username,
            content: content,
            isHost: false,
            replyTo: replyingTo,
            mentions: mentions
          });
        }
      });
    }
    
    input.value = '';
    replyingTo = null;
    document.getElementById('replyPreview').classList.remove('active');
    input.focus();
  }
}

function broadcastMessage(sender, content, exclude = null, replyTo = null, mentions = []) {
  connections.forEach(conn => {
    if (conn.open && conn !== exclude) {
      conn.send({
        type: 'message',
        sender: sender,
        content: content,
        isHost: isHost,
        replyTo: replyTo,
        mentions: mentions
      });
    }
  });
}

function broadcastSystemMessage(content) {
  connections.forEach(conn => {
    if (conn.open) {
      conn.send({
        type: 'system',
        content: content
      });
    }
  });
}

function broadcastUserCount() {
  connections.forEach(conn => {
    if (conn.open) {
      conn.send({
        type: 'user-count',
        count: connections.length + 1
      });
    }
  });
}

function broadcastUserList() {
  const userListToSend = roomUsers.map(user => ({
    id: user.id,
    username: user.username,
    isHost: user.isHost,
    joinTime: user.joinTime
  }));
  
  connections.forEach(conn => {
    if (conn.open) {
      conn.send({
        type: 'user-list',
        userList: userListToSend
      });
    }
  });
}

function broadcastUserInfo() {
  connections.forEach(conn => {
    if (conn.open) {
      conn.send({
        type: 'user-info-update',
        userId: peer.id,
        username: username
      });
    }
  });
}

function updateUserCount() {
  const count = isHost ? connections.length + 1 : userCount;
  document.getElementById('userCount').textContent = count;
}

function addMessage(sender, text, type, isHostMessage = false, replyTo = null, mentions = []) {
  const msgDiv = document.createElement('div');
  msgDiv.classList.add('message', type);
  msgDiv.setAttribute('data-msg-id', messageId);
  
  const msgData = {
    id: messageId,
    sender: sender,
    content: text,
    type: type,
    isHost: isHostMessage,
    replyTo: replyTo,
    mentions: mentions
  };
  
  messages.push(msgData);
  
  // Ê∑ªÂä†ÂõûÂ§ç‰ø°ÊÅØÊòæÁ§∫
  if (replyTo) {
    const replyDiv = document.createElement('div');
    replyDiv.className = 'message-reply';
    replyDiv.innerHTML = `<div class="message-reply-sender">‚Ü≥ ÂõûÂ§ç ${replyTo.sender}</div><div class="message-reply-content">${escapeHtml(replyTo.content)}</div>`;
    msgDiv.appendChild(replyDiv);
  }
  
  const senderSpan = document.createElement('span');
  senderSpan.classList.add('sender');
  senderSpan.textContent = sender;
  
  if (isHostMessage) {
    const hostBadge = document.createElement('span');
    hostBadge.classList.add('host-badge');
    hostBadge.textContent = 'Êàø‰∏ª';
    senderSpan.appendChild(hostBadge);
  }
  
  msgDiv.appendChild(senderSpan);
  
  // Â§ÑÁêÜ@ÊèêÂèäÂíåÂÜÖÂÆπÊòæÁ§∫
  const contentSpan = document.createElement('span');
  const processedContent = processMessageContent(text, mentions);
  contentSpan.innerHTML = processedContent;
  msgDiv.appendChild(contentSpan);
  
  const actions = document.createElement('div');
  actions.className = 'message-actions';
  
  const replyBtn = document.createElement('button');
  replyBtn.className = 'action-btn';
  replyBtn.innerHTML = '<i class="fas fa-reply"></i>';
  replyBtn.title = 'ÂõûÂ§çÊ≠§Ê∂àÊÅØ';
  replyBtn.onclick = () => replyToMessage(messageId);
  actions.appendChild(replyBtn);
  
  const mentionBtn = document.createElement('button');
  mentionBtn.className = 'action-btn';
  mentionBtn.innerHTML = '<i class="fas fa-at"></i>';
  mentionBtn.title = 'ÊèêÂèäÊ≠§Áî®Êà∑';
  mentionBtn.onclick = () => {
    const input = document.getElementById('messageInput');
    input.value += '@' + sender + ' ';
    input.focus();
  };
  actions.appendChild(mentionBtn);
  
  msgDiv.appendChild(actions);
  
  document.getElementById('chatMessages').appendChild(msgDiv);
  
  setTimeout(() => {
    msgDiv.classList.add('message-animation');
  }, 10);
  
  scrollToBottom();
}

function processMessageContent(text, mentions) {
  let result = escapeHtml(text);
  
  if (mentions && mentions.length > 0) {
    mentions.forEach(mention => {
      const regex = new RegExp(`@${mention}\\b`, 'g');
      result = result.replace(regex, `<span class="message-mention">@${mention}</span>`);
    });
  }
  
  return result;
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, char => map[char]);
}

function addSystemMessage(text) {
  const sysDiv = document.createElement('div');
  sysDiv.classList.add('system');
  sysDiv.textContent = text;
  document.getElementById('chatMessages').appendChild(sysDiv);
  scrollToBottom();
}

function scrollToBottom() {
  const div = document.getElementById('chatMessages');
  div.scrollTop = div.scrollHeight;
}

function leaveRoom() {
  if (peer) {
    peer.destroy();
    connections.forEach(conn => {
      if (conn.open) conn.close();
    });
    connections = [];
  }
  
  localStorage.removeItem('roomId');
  localStorage.removeItem('isHost');
  localStorage.removeItem('roomPassword');
  
  location.reload();
}

function showUserList() {
  const modal = document.getElementById('userListModal');
  const userListContainer = document.getElementById('userListContainer');
  const hostControls = document.getElementById('hostControls');
  
  userListContainer.innerHTML = '';
  
  const sortedUsers = [...roomUsers].sort((a, b) => {
    if (a.isHost) return -1;
    if (b.isHost) return 1;
    return new Date(a.joinTime) - new Date(b.joinTime);
  });
  
  sortedUsers.forEach(user => {
    const userItem = document.createElement('li');
    userItem.className = 'user-item';
    
    const avatarChar = user.username.charAt(0).toUpperCase();
    
    userItem.innerHTML = `
      <div class="user-avatar">${avatarChar}</div>
      <div class="user-info">
        <div class="user-name">
          ${user.username}
          ${user.isHost ? '<span class="host-badge">Êàø‰∏ª</span>' : ''}
        </div>
        <div class="user-status">${user.id === peer.id ? '(Êàë)' : ''}</div>
      </div>
    `;
    
    userListContainer.appendChild(userItem);
  });
  
  if (isHost) {
    hostControls.classList.add('active');
    
    const pauseBtn = document.getElementById('pauseRoomBtn');
    if (isRoomPaused) {
      pauseBtn.innerHTML = '<i class="fas fa-play"></i> ÊÅ¢Â§çÊàøÈó¥';
    } else {
      pauseBtn.innerHTML = '<i class="fas fa-pause"></i> ÊöÇÂÅúÊàøÈó¥';
    }
  } else {
    hostControls.classList.remove('active');
  }
  
  modal.classList.add('active');
}

function hideUserList() {
  const modal = document.getElementById('userListModal');
  modal.classList.remove('active');
}

document.getElementById('userListModal').addEventListener('click', function(e) {
  if (e.target === this) {
    hideUserList();
  }
});

function togglePauseRoom() {
  if (!isHost) return;
  
  isRoomPaused = !isRoomPaused;
  
  connections.forEach(conn => {
    if (conn.open) {
      conn.send({
        type: 'room-control',
        action: 'pause',
        paused: isRoomPaused
      });
    }
  });
  
  setRoomPaused(isRoomPaused);
  
  const pauseBtn = document.getElementById('pauseRoomBtn');
  if (isRoomPaused) {
    pauseBtn.innerHTML = '<i class="fas fa-play"></i> ÊÅ¢Â§çÊàøÈó¥';
    addSystemMessage('‰Ω†Â∑≤ÊöÇÂÅúÊàøÈó¥');
  } else {
    pauseBtn.innerHTML = '<i class="fas fa-pause"></i> ÊöÇÂÅúÊàøÈó¥';
    addSystemMessage('‰Ω†Â∑≤ÊÅ¢Â§çÊàøÈó¥');
  }
  
  hideUserList();
}

function setRoomPaused(paused) {
  isRoomPaused = paused;
  const chatMessages = document.getElementById('chatMessages');
  const messageInput = document.getElementById('messageInput');
  const sendButton = messageInput.nextElementSibling;
  
  if (paused && !isHost) {
    messageInput.disabled = true;
    sendButton.disabled = true;
    chatMessages.classList.add('room-paused');
  } else {
    messageInput.disabled = false;
    sendButton.disabled = false;
    chatMessages.classList.remove('room-paused');
  }
}

function deleteRoom() {
  if (!isHost) return;
  
  if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ÊàøÈó¥ÂêóÔºüÊâÄÊúâÁî®Êà∑Â∞ÜË¢´Êñ≠ÂºÄËøûÊé•„ÄÇ')) {
    connections.forEach(conn => {
      if (conn.open) {
        conn.send({
          type: 'room-control',
          action: 'delete'
        });
      }
    });
    
    addSystemMessage('‰Ω†Â∑≤Âà†Èô§ÊàøÈó¥');
    setTimeout(leaveRoom, 2000);
  }
}

document.addEventListener('gesturestart', function(e) {
  e.preventDefault();
});

document.addEventListener('dblclick', function(e) {
  e.preventDefault();
});

const allInputs = document.querySelectorAll('input');
allInputs.forEach(input => {
  input.addEventListener('focus', function() {
    document.body.classList.add('input-focused');
  });
  
  input.addEventListener('blur', function() {
    document.body.classList.remove('input-focused');
  });
});
</script>

</body>
</html>
